#!/usr/bin/env bash
# Pre-commit hook to detect sensitive information

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to detect
declare -A PATTERNS=(
    ["AWS Account ID"]='[0-9]{12}'
    ["AWS Access Key"]='AKIA[0-9A-Z]{16}'
    ["AWS Secret Key"]='[A-Za-z0-9/+=]{40}'
    ["Route53 Hosted Zone"]='Z[0-9A-Z]{10,}'
    ["S3 Bucket (specific)"]='(agentmesh|agidiy)\.sauhsoj\.people\.aws\.dev'
    ["Email"]='[a-zA-Z0-9._%+-]+@(amazon\.com|aws\.dev)'
    ["Private Key"]='-----BEGIN (RSA |EC )?PRIVATE KEY-----'
)

# Files to check (staged files)
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    exit 0
fi

FOUND_SENSITIVE=0

# Check each file
for FILE in $FILES; do
    # Skip binary files
    if file "$FILE" | grep -q "text"; then
        for NAME in "${!PATTERNS[@]}"; do
            PATTERN="${PATTERNS[$NAME]}"
            
            # Skip CloudFront hosted zone (it's a constant)
            if [[ "$PATTERN" == *"Z[0-9A-Z]"* ]] && grep -q "Z2FDTNDATAQYW2" "$FILE"; then
                continue
            fi
            
            if grep -qE "$PATTERN" "$FILE"; then
                if [ $FOUND_SENSITIVE -eq 0 ]; then
                    echo -e "${RED}‚ùå Sensitive information detected!${NC}"
                    echo ""
                    FOUND_SENSITIVE=1
                fi
                
                echo -e "${YELLOW}File: $FILE${NC}"
                echo -e "${YELLOW}Pattern: $NAME${NC}"
                grep -nE "$PATTERN" "$FILE" | head -3
                echo ""
            fi
        done
    fi
done

if [ $FOUND_SENSITIVE -eq 1 ]; then
    echo -e "${RED}Commit blocked. Please remove sensitive information.${NC}"
    echo ""
    echo "Allowed patterns:"
    echo "  - Use placeholders: <your-account-id>, \$AWS_ACCOUNT_ID"
    echo "  - Use .env.local for local secrets (already in .gitignore)"
    echo "  - CloudFront hosted zone Z2FDTNDATAQYW2 is allowed (constant)"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

exit 0
